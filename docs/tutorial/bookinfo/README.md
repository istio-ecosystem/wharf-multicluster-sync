
# Prerequisite

This demo assumes you have configured Istio with multicluster agents.  Follow the
instructions [here](/istio-ecosystem/wharf-multicluster-sync/tree/master/docs/install/README.md)

# Demo

First, install Bookinfo with _details_ and _productpage_ on cluster1.
The _reviews_ (version:v1) will be on cluster2

```
kubectl --context $CLUSTER1 apply -f bookinfo-norating-noreviews.yaml
kubectl --context $CLUSTER1 apply -f bookinfo-gateway.yaml
kubectl --context $CLUSTER2 apply -f bookinfo-reviews-v1.yaml
```

![Unconnected Bookinfo](bookinfo-unconnected.png?raw=true "Unconnected Bookinfo")

## Before the services are connected

Follow the instructions at https://istio.io/docs/examples/bookinfo/#determining-the-ingress-ip-and-port to find Bookinfo.

Browse to http://${GATEWAY_URL}/productpage to verify that bookinfo is connected and that
details are present but not reviews.

![Unconnected UI](ui-unconnected.png?raw=true "Unconnected UI")

## Expose reviews-v1 on cluster2

We will create a Service Exposition Policy to expose reviews-v1 on cluster2 to services on cluster1.

```
kubectl --context $CLUSTER2 apply -f reviews-exposure.yaml
```

The policy we are applying looks like

```
## Expose the "reviews" service
apiVersion: multicluster.istio.io/v1alpha1
kind: ServiceExpositionPolicy
metadata:
  name: reviews
spec:
  exposed:
  - name: reviews
    port: 9080
```

It just says to expose _reviews:9080_ to all clusters, all namespaces, within our Root CA.

Upon running the above command the agent created Istio configuration on $CLUSTER2.  Verify that
the configuration was created

```
kubectl --context $CLUSTER2 get gateways,virtualservices,destinationrules
```

You should see a gateway, virtual service, and destination rule for reviews.  The topology
is now

![Bookinfo with reviews v1](bookinfo-reviews-v1.png?raw=true "Bookinfo with reviews v1")

## Inspect the binding on cluster1

Exposing on cluster2 caused a _RemoteServiceBinding_ to be created on cluster1.

```
kubectl --context $CLUSTER1 get remoteservicebindings
```

If the binding is in `live` mode the client-side Istio configuration will be created automatically.

```
kubectl --context $CLUSTER1 get service,destinationrule,serviceentry
```

## Verify that the reviews is present in the UI

![Connected UI](ui-connected.png?raw=true "Connected UI")

Reload http://${GATEWAY_URL}/productpage in the browser.  Verify that reviews are present.

## Deploying and Exposing the Ratings microservice

We will now deploy a _ratings_ service on cluster3 and expose it.

### Optional: Manually accept configuration

*OPTIONAL*: For this tutorial sub-step we will
show how to configure client-side multicluster agents to run in manual mode.

First, do `kubectl --context $CLUSTER2 edit cm mc-configuration`.  Change `ConnectionMode: live`
to `ConnectionMode: potential` and save.

Note that it may take up to 30 seconds before the change to potential mode takes effect on the agent.  You may wish to do a `sleep 30` to making changes too quickly.

## Deploy and expose Ratings

```
kubectl --context $CLUSTER1 apply -f bookinfo-ratings.yaml
kubectl --context $CLUSTER1 apply -f ratings-exposure.yaml
```

### Optional: Make configuration live

*ONLY PERFORM IF DID OPTIONAL 'potential' STEP ABOVE*: For this tutorial sub-step we will
show how listing of potential remote services and making them live.

First, verify that a new RemoteServiceBinding was created on $CLUSTER2 after the service
on $CLUSTER1 was created

```
kubectl --context $CLUSTER2 get remoteservicebindings
kubectl --context $CLUSTER2 edit remoteservicebinding cluster3-services
```

Change `connection: potential`
to `connection: live` and save.  The agent will create the configuration.  The following
step will show it.

## Verify configuration generated by live binding

As before, exposing ratings created configuration on peer cluster2:

```
kubectl --context $CLUSTER2 get service,destinationrule,serviceentry
```

## Deploying a new version of reviews that will consume ratings

We will now deploy.  There is no need to expose this version of reviews.  The exposure
of the _reviews_ *Service* exposed all pods of all versions.  The new version will be added
to the normal round-robin.
 
```
kubectl --context $CLUSTER2 apply -f bookinfo-reviews-v2.yaml
```

![Bookinfo with Stars](ui-stars.png?raw=true "Bookinfo with Stars")

(The stars only appear if v2 of the _reviews_ service can contact _ratings_ to determine
the number of stars.)

The final version of the cross-cluster configuration includes communication between all three
clusters.

![Bookinfo with reviews v2 and ratings](bookinfo-ratings.png?raw=true "Bookinfo with reviews v2 and ratings")


# Cleanup

To remove the demo artifacts, execute the following:

```
kubectl --context $CLUSTER2 delete -f reviews-exposure.yaml
kubectl --context $CLUSTER1 delete service reviews
kubectl --context $CLUSTER1 delete -f ratings-exposure.yaml
kubectl --context $CLUSTER2 delete service ratings
kubectl --context $CLUSTER1 delete -f bookinfo-norating-noreviews.yaml
kubectl --context $CLUSTER1 delete -f bookinfo-gateway.yaml
kubectl --context $CLUSTER2 delete -f bookinfo-reviews-v1.yaml
kubectl --context $CLUSTER2 delete -f bookinfo-reviews-v2.yaml
kubectl --context $CLUSTER1 delete -f bookinfo-ratings.yaml
```
